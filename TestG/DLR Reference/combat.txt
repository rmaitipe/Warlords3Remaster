* COMBAT RESOLUTION *
(From Warlords III Central)

I. PRE-COMBAT

* Step 1: Curse, Poison, Disease and Paralysis

Total any curse, poison, disease and paralysis bonuses for both sides. The
value for all units in a side is summed up to give a total. That total is
multiplied by 4 to give a Percentage Chance every opponent army will be
affected.
Eg. Side A has 3 mummies.
    The poison is summed up as 3+3+3=9 poison points. This is multiplied by
    4 to give a total of 36% chance of poisoning every enemy unit.

Resolve Curse first by applying the curse % to every enemy unit on both sides.
Resolve Poison/Disease/Paralysis next in no particular order to every enemy
on both sides..

The effects are as follows:
Curse - removes blessing (if army is blessed) and medals (if army has medals)
Poison - unit has strength reduced by 2 down to a minimum of 1.
Disease - unit has hits reduced down by 1 to a minimum of 1
Paralysis - unit has all remaining movement removed for this turn and is -5
            movement on all subsequent turns.

NOTE 1: Units that are blessed are immune to poison/disease/paralysis. That's
        why curse goes first so that a blessed unit can suffer curse followed
        by poison/disease/paralysis in a single combat.
NOTE 2: All effects of poison/curse/disease/paralysis are permanent until the
        unit is blessed or dies in combat.
NOTE 3: A unit can only be affected by an ability once. So a unit can be
        poisoned in a combat and survive. Then when it enters the next combat
        it can't be poisoned again, but it could be diseased/paralyzed if it
        wasn't already diseased/paralyzed. However if a unit that is poisoned
        is later blessed (removing the poison), it can be cursed and poisoned
        again.
NOTE 4: Units with poison/disease/paralysis/curse ability are themselves immune
        to their particular ability. So Mummies with poison are immune to being
        poisoned but they can be cursed/diseased/paralyzed.
NOTE 5: Cursing a unit without a blessing has no effect on that unit (unless
        the unit has medals) and it does not need to get double blessed in order
        to be blessed.
NOTE 6: When curse removes a blessing from a unit, it also removes 1 strength
        from that unit (since blessing gives a unit +1 strength). This reduces
        the unit back down to it's normal strength. However there is a strange
        effect with natural 9 str units. When a natural 9 str unit (a dragon)
        gets blessed it does not get +1 strength since the max strength for a
        unit is 9. But when it is cursed, it drops in strength to 8 due to the
        -1 strength modifier from curse. So be careful blessing those dragons
        if the opponent has curse.
NOTE7:  Medals removed by curse that came from a spell (Berzerk) or item
        (Medal of Valor) are automatically restored to the unit at the end
        of the battle (assuming the unit survives). But Medals that were awarded
        previously to a unit for surviving combat are permanently removed
        although the unit can get new ones in the future.
NOTE8:  Units with 1 strength are in effect immune to poison and units with 1
        hit are in effect immune to disease.


* Step 2: Calculate Combat Bonuses

Calculate any terrain bonus for each unit from both sides and add it to that
units strength. For purposes of combat the terrain is defined as the terrain
the defending stack is in. Terrain bonus's are only applied to the unit with
the bonus and not the whole stack. After adding the terrain bonus's do a check
to make sure that the max strength of every unit is 9. Cities that are located
in terrain like hills/marsh/forest convey both the city terrain and the hills/
marsh/forest terrain.
eg. 2 Minotaurs and a Knight attack a city. The Minotaurs are +2 vs city, so
    before any other bonus's are added/subtracted the Minotaurs get a +2 to
    their strength taking them from a 5 to a 7. The Knight has an open terrain
    bonus so they get no extra strength due to combat in a city. If that same
    combat took place on an open road, the Minotaurs strength would instead be
    5 before any other bonus's are added/subtracted but the Knights would get
    their +2 bonus in the open so they would go from a 5 to a 7 strength.

Total all combat bonuses for each side with the following formula: (Side
A Leadership - Side B Chaos) + (Side A Morale - Side B Fear) + (Side A
Fortification - Side B Siege).  Reverse the formula for Side B.  Each
individual value is limited from 0 to +5.  The value range for each set
of brackets is limited from -1 to +5.  The total for the 3 sets of
brackets is also limited to an a range of -3 to +5.  Add Side A's bonus
to every unit in side A's stack and Side B's bonus to every unit in side
B's stack.  The bonus from a city fortification is included in that
side's fortification bonus.  For example:
  Side A has +3 leadership, +1 morale, +1 fortify, +1 chaos, +5 fear, 0 siege
  Side B has +2 leadership, +2 morale, +1 fortify, +2 chaos, +3 fear, +1 siege
  Side A bonus = (3-2)+(1-3)+(1-1) = (1)+(-2 limited to -1)+(0)= 0 bonus
  Side B bonus = (2-1)+(2-5)+(1-0) = (1)+(-3 limited to -1)+(1)= +1 bonus
After adding the above bonuses, do a check to make sure that the min
strength of every unit is 1 and the max strength of every unit is 14.

Total any banding bonus for both sides and add it to the units with the
banding bonus. Only units of the same type can get a banding bonus, not
all units with a possible banding bonus.  For example:
  6 Giant Rats and a Peasant attack a city.  After all other bonuses are
  factored in (none in this case), the banding bonus is calculated as +5
  for the rats and 0 for the peasants.  So the rats' strength would rise
  from 1 to 6 while the strength of the peasant would remain 1 (since
  there is only 1 peasant and he doesn't get the banding bonus from the
  rats since he is not a rat).

Total any items with strength bonuses for heroes and add them to the
hero's strength.

After adding the above bonuses, do a check to make sure that the max
strength of every unit is 15.

NOTE1: Because banding bonuses are calculated AFTER other bonuses, units
       with banding can reach 15 strength. Hero's can also reach 15
       strength. They are the only types units that can reach 15
       strength.

NOTE2: The stack totals for leadership/morale/fortify/chaos/fear/siege
       is arrived at via the following formula: Best unit bonus (heroes
       are units!) + best spell bonus + best item bonus. The one
       exception is fortification bonus from cities.  That is added in
       addition to any other fortification bonus from unit/spell/item.
       eg. Hero with +2 morale ability and Archon with +3 morale equals +3
           morale as hero and Archon are both units so +3 is the best bonus.
       eg. Hero with Orb of Balance for +1 morale and Archon equals +4 as item
           is +1 and unit (Archon) is +3.
       eg. Hero with +1 Leadership and two +1 leadership items equals +2
           leadership as unit (hero) is +1 and best item bonus is +1.
       eg. Hero with Bravery spell for +1 morale and Orb of Balance item
           and an Archon equals +5 as item (orb) is +1, spell is +1 and
           Archon is +3. 
       eg. Hero with +1 fortify and Iceguard with +1 fortify are in a
           city with +2 fortify equals +3 fortify as unit
           (hero/Iceguard) is +1 and city is +2.
       For this reason, it's important to distribute your items among
       your heroes to maximize their use. If your total in a category
       exceeds +5 it is rounded down to +5 for calculation purposes.  So
       a hero with +5 leadership and a +1 leadership item equals +5
       leadership for combat calculations.

II. INDIVIDUAL UNIT COMBAT

There are 9 basic steps to combat once the units start facing each
other. They are as follows:

1) Any acid ability for the attacker and defender is calculated and
   checked to see if an attacker or defender took an acid hit.  A check
   is made to see if a unit died.  If so, next unit in stack steps up and
   go back to step 1.  If a stack is empty, combat is done.
2) Any lightning ability for the attacker and defender is calculated and
   checked to see if an attacker or defender took a lightning hit.  A
   check is made to see if a unit died.  If so, next unit in stack steps
   up and go back to step 1.  If a stack is empty, combat is done.
3) Any assassination ability for the attacker and defender is calculated
   and checked to see if an attacker or defender took an assassination
   hit.  A check is made to see if a unit died.  If so, next unit in
   stack steps up and go back to step 1.  If a stack is empty, combat is
   done.
4) Any missile ability for the attacker and defender is calculated and
   checked to see if an attacker or defender took an missile hit.  A
   check is made to see if a unit died.  If so, next unit in stack steps
   up and go back to step 1.  If a stack is empty, combat is done.
5) A die is rolled for both attacker and defender.
6) If either/both units have a medal, an extra roll is made for that
   unit(s) and the lower of the 2 rolls is chosen.
7) A check is made to see if either unit took a hit.  If a unit took a
   hit a check to see if the unit which delivered the hit has the
   trample ability which does extra damage.  If a unit took a hit a
   second check is make to see if the unit which delivered the hit has a
   slayer ability and the unit which took the hit is vulnerable to that
   particular slayer ability.  If so, a roll is made to see if the
   slayer ability is successful.
8) A check is made to see if a unit died.  If so, next unit in stack
   steps up and go back to step 1.  If stack is empty, combat is done.
9) If both units survived go back to step 5.

* Step 1: Acid Special Attack

Each plus of acid equals a 10% chance to hit with acid. A successful
acid hit reduces the enemy strength by 1/2 rounded down. Acid
automatically kills 1 strength units if it hits them (no chance for the
dead unit to lightning, assassinate or missile etc). The acid total is
calculated as unit acid ability + best acid ability from spell + best
acid ability from item. Acid bonuses between attacker and defender are
offset.
eg. A Black Dragon with +5 acid faces a Peasant with 0 acid. The Black dragon
    has a 50% chance to hit the Peasant with acid.
eg. A Black Dragon with +5 acid faces a Green Slime with +2 acid. The Black
    Dragon has a 30% chance to hit the Green Slime with acid and the Green
    Slime has 0% chance to hit the Black Dragon.
eg. A Monk with +2 acid from Wrath of Kali spell and Black Dragon faces a
    Peasant. The Black Dragon has a 70% (5+2) chance to hit the Peasant with
    acid.

NOTE1: The acid attack is calculated once for every unit faced in combat. So
       if a Black Dragon survived a combat vs 8 units it will have had 8 acid
       attacks, 1 for each enemy faced.
NOTE2: Units with self warding or warding from a group warding ability reduce
       the chances of an acid hit. In case there are several units with the group warding
       ability, these values are added up to a total group warding of +3. The total value
       for group warding is then added to any self warding other units may have to yield
       the total warding score for that unit. Each plus of warding cancels out a plus of
       acid. The warding bonus is in addition to any acid bonus for calculations of
       offsetting acid attacks. Warding is effective against every unit faced in combat.
       It works the same way against the lightning (see step 2) and assassin (see step 3)
       special attacks.
       eg. A Black Dragon with +5 acid faces a Knight with +1 warding. The Black
           Dragon has a 40% chance to hit the Knight with acid.
       eg. A Black Dragon with +5 acid faces a Green Slime with +2 acid and a
           Knight with +1 group warding. The Black Dragon has a 20% chance to
           hit the Green Slime (5-2=3, 3-1=2) with acid and a 40% chance to
           hit the Knight with acid.


* Step 2: Lightning Special Attack

Lightning works exactly the same as acid except it reduces the opponents hits
by 1/2 rounded down.

NOTE1: Warding is also effective against the lightning special attack
       (see note 2 above).

* Step 3: Assassination Special Attack

Each plus of assassination equals a 10% chance to kill. A successful assassin
roll kills the enemy unit outright. Assassination is only effective vs the
first enemy unit faced in combat regardless of whether or not the assassination
chance is successful. The assassination total is calculated as unit
assassination ability + best assassination ability from spell + best
assassination ability from item. Assassination bonus's between attacker and
defender are offset.
eg. A Gnoll Cavalry with +4 assassin faces a Archon with 0 assassin. The Gnoll
    Cavalry has a 40% chance to kill the Archon outright with assassination.
eg. A Gnoll Cavalry with +4 assassin faces a Gnoll with +1 assassin. The Gnoll
    Cavalry has a 30% chance to kill the Gnoll outright with assassination and
    the Gnoll has 0% chance to kill the Gnoll Cavalry with assassination.
eg. A Thief with +2 assassin and spider ring +3 assassin faces a Green Dragon.
    The Thief has 50% (2+3) chance to kill the Green Dragon with assassination.

NOTE1: Once a units assassination chance is used up that units assassin chance
       is no longer used when calculating offsetting assassin bonus's.
       eg. 2 Gnolls attack 2 Gnolls. The first 2 Gnolls cancel out each others
           assassination bonus so there is no chance for assassination. The
           attacking Gnoll kills the defending Gnoll. The next defending Gnoll
           steps into combat. Now the defending Gnoll has a 10% chance to kill
           the attacking Gnoll by assassination since the attacking Gnoll no
           longer has an assassination chance (used up). If the defending Gnoll
           then kills the attacking Gnoll and the 2nd attacking Gnoll steps up
           it will have a 10% chance to assassinate the defending Gnoll.
NOTE2: Warding is also effective against the assassin special attack
       (see note 2 above).



* Step 4: Missile Special Attack

Each plus of missiles equals 1 free 'shot' at an enemy unit when the unit with
the missile ability first enters combat. A successful missile hit kills the
enemy unit outright. Each missile shot is resolved as 1 round of normal combat
which is described in step 5. During these missile attacks, the unit with the
missile ability can't suffer a hit in combat, but if they get a successful
hit on the enemy, then they kill it. If a unit kills the enemy with a missile
hit then any left over shots carry on to the next enemy unit. The missile total
is calculated as unit missile ability + best missile ability from spell + best
missile ability from item. Missile bonus's between attacker and defender are
offset.
eg. A Moonguard with +4 missile faces an Minotaur 0 missile. The Moonguard
    has 4 rounds of combat to kill the Minotaur with missiles.
eg. A Moonguard with +4 missile faces a Archer with +2 missile. The Moonguard
    has 2 rounds of combat kill the Archer with missiles and the Archer has
    0 rounds of combat to kill the Moonguard with missiles.
eg. A Ranger with +3 missile and the bow of speed +6 missile faces a Minotaur.
    The Ranger has 9 (3+6) rounds of combat to kill the Minotaur with missiles.
eg. A Moonguard with +4 missile faces 2 Light Infantry with 0 missile. The
    Moonguard has 4 rounds of combat to kill the 1st Light Infantry with
    missiles. If he kills the Infantry with the 2nd shot, then when the next
    Infantry steps up, the Moonguard has 2 rounds of combat left to kill the
    second Light Infantry with missiles.

NOTE1: Non-Flying units with 4 hp (either naturally or from a spell/item) when
       they enter combat are immune to missile fire. This immunity will use up
       all the enemy units missile shots so none will carry over to the next
       unit. This immunity persists even if the 4 hit unit drops down to 3 hits
       during the battle and then faces a unit with missile ability. But if a
       4 hit unit is diseased or lifedrained down to 3 hits then it is
vulnerable to archery.
       eg. A Moonguard with +4 missile faces a Dwarf Runner with 4 hp. The
           Moonguard has 0 rounds of combat to kill the Dwarf Runner with
           missiles due to the 4 hp immunity and all missile attacks are used
           up.
       eg. A Moonguard with +4 missile faces a Priest with Mighty Feast Spell
           and an Undead Beast. The Moonguard has 0 rounds of combat to kill
           the Undead Beast with missiles due to the Undead Beast due to the
           4 hp immunity (3+1 from Mighty Feast) and all missile attacks are
           used up.
       eg. A Moonguard with +4 missile faces a Dwarf Runner who is diseased.
           The Moonguard has 4 rounds of combat to kill the Dwarf Runner with
           missiles due to the Dwarf Runner only having 3 hp (4-1 from disease).
       eg. A Moonguard with +4 missile and a Light Infantry faces a Dwarf
           Runner. The Light Infantry manages to hit the Dwarf Runner twice
           before dying reducing the Dwarf Runner to 2 hits. The Moonguard now
           faces the Dwarf Runner and has 0 rounds of combat to kill the Dwarf
           Runner with missiles due to the Dwarf Runner have 4 hp immunity when
           combat started even though it currently only has 2 hits.
NOTE2: Units with a missile ability get +3 strength for missile combat purposes
       when facing units that are flying. This includes natural flyers like
       Dragons and ground units that are flying due to a spell/item/hero ability.
       eg. A Moonguard with +4 missile faces an Undead Dragon with 0 missile.
           The Moonguard gets 4 rounds of combat at +3 strength (9 instead of
           6) due to the Undead Dragon being a flying unit. If the missile
           attacks are all unsuccessful then normal combat takes place with
           the Moonguard having a strength of 6.
       eg. A Moonguard with +4 missile faces an Vampire with Flight ability
           and an Undead Beast with 0 missile. The Moonguard gets 4 rounds of
           combat at +3 strength (9 instead of 6) due to the Undead Beast
           flying from the Vampire Flight ability unit. If the missile attacks
           are all unsuccessful then normal combat takes place with the
           Moonguard having a strength of 6.
NOTE3: Once a units missile chance is used up that units missile chance is no
       longer used when calculating offsetting missile bonus's.
       eg. 2 Moonguard attack 2 Moonguard. The first 2 Moonguards cancel out
           each others missile bonus so there is no chance for missile hits.
           The attacking Moonguard kills the defending Moonguard. The next
           defending Moonguard steps into combat. Now the defending Moonguard
           has 4 rounds of missile combat to kill the attacking Moonguard by
           missiles since the attacking Moonguard no longer has any missile
           shots left. If the defending Moonguard then kills the attacking
           Moonguard and the 2nd attacking Moonguard steps up it will have 4
           rounds of missile combat to kill the defending Moonguard with
           missiles.
NOTE4: Medals are not taken into account for the attacker or defender when
       doing the missile combat rounds. So if either/both units have medals
they will not get an extra roll for the missile attacks.


* Steps 5-9: Normal Combat

A die is rolled (normally 20 sided) for the attacker and the defender and
compared against their strength. If either/both the attacker or defender have
medals then a 2nd die is rolled (30 sided for 1 medal, 26 sided for 2 medals,
22 sided for 3 medals and 18 sided for 4 medals). The lower of the 2 rolls is
kept as lower rolls are better. The attackers die roll is compared to the
defenders strength and vice versa. If a roll is lower than the units strength
it indicates a potential for a hit. The results for both units are compared
as follows:

Attacker roll <= attacker str AND defender roll <= defender str : no effect
Attacker roll <= attacker str AND defender roll >  defender str : hit defender
Attacker roll >  attacker str AND defender roll <= defender str : hit attacker
Attacker roll >  attacker str AND defender roll >  defender str : no effect

If a unit takes a hit it loses 1 hit point and 2 checks are then made.

The first check is to see if the unit which delivered the hit has trample
ability. If it has a trample ability a check is made to see if the unit which
was hit is flying (either a natural flyer or flying from a spell/item/hero
ability). If the unit is flying, it is immune to being trampled and if not
1 extra hit is removed for each plus of trample ability
eg. An Iron Golem with +3 trample hits an Undead Beast with 3 hp. The Iron
    Golem has trample ability and the Undead Beast is not flying so the Iron
    Golem does 1 hp of damage from the hit and 3 more from the trample for a
    total of 4 hp which kills the Undead Beast. Any extra damage above what is
    needed to reduce the enemy unit to 0 hp is not carried over to other enemy
    units.
eg. An Iron Golem with +3 trample hits a Green Dragon with 3 hp. The Iron
    Golem has trample ability but the Green Dragon is flying so the Iron
    Golem does 1 hp of damage from the hit and 0 from the trample so the Green
    Dragon has 2 hp left.

The second check is to see if the unit which was hit is vulnerable to a slayer
ability. If it is vulnerable to a slayer ability a check is made to see if the
unit which delivered the hit has that slayer ability. If so, then a slayer
roll is made where each plus of slayer ability equals a 10% chance to kill
the unit outright. The slayer ability is calculated as unit slayer ability +
best slayer ability from spell + best slayer ability from item. Slayer abilities
are NOT offset between attacker and defender.
eg. An Knight Lord with +2 dragonslayer hits a Green Dragon with 3 hp. The Green
    Dragon is vulnerable to dragonslayer and the Knight Lord has a dragonslayer
    ability of +2 so a roll is made with a 20% chance to kill the Green Dragon
    outright. If the slayer roll is unsuccessful the Green Dragon is reduced to
    2 hp otherwise it is dead.

NOTE1: Any slayer ability from a unit/spell/ability is automatically conferred
       to every unit in the stack.
       eg. An Knight Lord with +2 dragonslayer and a Minotaur attack a Green
           Dragon. The Minotaur hits the Green Dragon who still has 3 hp. The
           Green Dragon is vulnerable to dragonslayer and the Minotaur has a
           dragonslayer ability of +2 (from the Knight Lord) so a roll is made
           with a 20% chance to kill the Green Dragon outright. If the slayer
           roll is unsuccessful the Green Dragon is reduced to 2 hp otherwise
           it is dead.


If a unit drops to 0 or less hp it is killed and the next unit (if there are
any left) in the stack steps up to battle and you go back to step 1.
